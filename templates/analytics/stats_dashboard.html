<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'std_elements/head.html' %}

    <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>

    <!-- Custom statics -->
    <link rel="stylesheet" href="/static/css/dynamic.css">
  
    <title>3TH - Statistik</title>
</head>
<body class="layout-wrapper" data-layout="dashboard" style="overflow: auto;">
  
    <h1>üìä Statistik-Dashboard</h1>

    <form id="filters" style="display: grid; grid-template-columns: 20ch auto; grid-gap: 1rem;">

        <label for="start">Von:</label>
        <input type="date" name="start_date" id="start" value="{{ start_date_prefill }}">
        <label for="end">Bis:</label>
        <input type="date" name="end_date" id="end" value="{{ end_date_prefill }}">

        <label for="category">Kategorie:</label>
        <select name="game_category_id" id="category">
        <option value="">Alle</option>
            {% for cat in game_categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>

        <label for="event-type">Event Typ:</label>
        <select name="event_type_id" id="event-type">
        <option value="">Alle</option>
            {% for et in event_types %}
            <option value="{{ et.id }}">{{ et.name }}</option>
            {% endfor %}
        </select>

        {% if session.is_admin %}
            <label for="user">Benutzer:</label>
            <select name="user_id" id="user">
                <option value="">Alle</option>
                {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                {% endfor %}
            </select>
        {% else %}
            <input type="hidden" name="user_id" value="{{ session.user_id }}">
        {% endif %}

        
</form>

<div id="chart-loading" style="display:none;">‚è≥ L√§dt...</div>
<div id="chart-events-category" style="height: 500px;"></div>
<div id="chart-events-week" style="height: 500px"></div>
<div id="events-table" style="margin-top: 2rem; margin-bottom: 4rem;">
    <h2>üìã Event-Matrix</h2>
    <div id="event-matrix-table-container">L√§dt...</div>
</div>

<script>
const form = document.getElementById('filters');
const chart = echarts.init(document.getElementById('chart-events-category'));
const loader = document.getElementById('chart-loading');

function fetchAndRenderChart() {
    loader.style.display = 'block';

    const formData = new FormData(form);

    const start = document.getElementById("start").value;
    const end = document.getElementById("end").value;
    const titleRange = `Events (${start} bis ${end})`;

    fetch("{{ url_for('analytics_bp.chart_events_per_category') }}", {
        method: "POST",
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        const colors = [
        '#5470C6', '#91CC75', '#FAC858', '#EE6666', '#73C0DE', 
        '#3BA272', '#FC8452', '#9A60B4', '#EA7CCC'
        ];

        chart.setOption({
            color: colors,
            title: { text: titleRange, left: 'center' },
            tooltip: { trigger: 'item' },
            series: [
                {
                    type: 'sunburst',
                    data: data.data,
                    radius: [0, '90%'],
                    label: {
                        rotate: 'radial'
                    }
                }
            ]
        });
    })
    .catch(err => console.error("Fetch failed", err))
    .finally(() => loader.style.display = 'none');
}

form.addEventListener("change", fetchAndRenderChart);

// Initial load
fetchAndRenderChart();


const chartDom = document.getElementById('chart-events-week');
const weeklyChart = echarts.init(chartDom);

const defaultLabelOption = {
    show: true,
    position: 'insideBottom',
    distance: 15,
    align: 'left',
    verticalAlign: 'middle',
    rotate: 90,
    formatter: '{name|{a}}',
    fontSize: 16,
    rich: { name: {} }
};

const hoverLabelOption = {
    show: true,
    position: 'top',
    distance: 20,
    align: 'center',
    verticalAlign: 'middle',
    rotate: 0,
    formatter: '{c}',
    fontSize: 16,
    rich: { name: {} }
};

function fetchWeeklyChart() {
    loader.style.display = 'block';
    const formData = new FormData(form);

    fetch("{{ url_for('analytics_bp.chart_events_per_week') }}", {
        method: "POST",
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        const option = {
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                triggerOn: 'click'
            },
            legend: {
                data: data.series.map(s => s.name)
            },
            toolbox: {
                show: true,
                orient: 'vertical',
                left: 'right',
                top: 'center',
                feature: {
                    mark: { show: true },
                    magicType: { show: true, type: ['line', 'bar'] },
                    saveAsImage: { show: true }
                }
            },
            xAxis: [
                {
                    type: 'category',
                    axisTick: { show: false },
                    data: data.weeks
                }
            ],
            yAxis: [
                {
                    type: 'value'
                }
            ],
            series: data.series.map(s => ({
                name: s.name,
                type: 'bar',
                barGap: 0,
                label: defaultLabelOption,
                emphasis: { 
                    focus: 'series',
                    label: hoverLabelOption
                },
                data: s.data
            }))
        };

        weeklyChart.setOption(option);
    })
    .catch(err => console.error("Weekly chart fetch failed", err))
    .finally(() => loader.style.display = 'none');
}




let activeSeriesIndex = null;

chartDom.addEventListener('mousemove', (event) => {
  const pointInPixel = [event.offsetX, event.offsetY];
  const pointInGrid = weeklyChart.convertFromPixel({ seriesIndex: 0 }, pointInPixel);

  const found = weeklyChart.containPixel('grid', pointInPixel);

  if (!found) {
    // If moved out of grid area, hide all labels if active
    if (activeSeriesIndex !== null) {
      toggleLabels(null);
    }
    return;
  }

  const hovered = weeklyChart.convertFromPixel({ seriesIndex: 0 }, pointInPixel);
  
  const params = weeklyChart.convertFromPixel('grid', pointInPixel);
  // Can't get seriesIndex easily from pixel, so fallback:

  // Instead use ECharts event handlers to detect hovered series:
  // We'll use 'highlight' events on the chart instance instead of this

});

weeklyChart.on('mouseover', function (params) {
  if (params.componentType === 'series') {
    if (params.seriesIndex !== activeSeriesIndex) {
      activeSeriesIndex = params.seriesIndex;
      toggleLabels(activeSeriesIndex);
    }
  }
});

weeklyChart.on('mouseout', function (params) {
  if (params.componentType === 'series') {
    // Delay hiding labels to avoid flicker when moving between bars in same series
    setTimeout(() => {
      // If mouse is not currently over same series, hide all labels
      if (activeSeriesIndex === params.seriesIndex) {
        toggleLabels(null);
        activeSeriesIndex = null;
      }
    }, 150);
  }
});

function toggleLabels(seriesIndex) {
  const option = weeklyChart.getOption();
  option.series.forEach((s, i) => {
    if (seriesIndex == null) {
        s.label = defaultLabelOption
    } else {
        s.label = hoverLabelOption
    }

  });
  weeklyChart.setOption(option);
}




form.addEventListener("change", fetchWeeklyChart);
fetchWeeklyChart();


function fetchEventMatrixTable() {
    const formData = new FormData(form);

    fetch("{{ url_for('analytics_bp.table_events_matrix') }}", {
        method: "POST",
        body: formData
    })
    .then(r => r.text())
    .then(html => {
        document.getElementById("event-matrix-table-container").innerHTML = html;
    })
    .catch(err => {
        console.error("Matrix fetch failed", err);
        document.getElementById("event-matrix-table-container").innerText = "Fehler beim Laden der Matrix.";
    });
}

form.addEventListener("change", fetchEventMatrixTable);
fetchEventMatrixTable();
</script>

</body>
</html>
