<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'std_elements/head.html' %}

    <!-- fontawesome -->
    <script defer src="/static/js/fontawesome/fontawesome.min.js"></script>
    <script defer src="/static/js/fontawesome/solid.min.js"></script>

    <!-- Custom statics -->
    <link rel="stylesheet" href="/static/css/dynamic.css">
    <script src="/static/js/general.js" defer></script>
    <script src="/static/js/dynamic-view.js" defer></script>

    <!-- PWA Capability -->
    <link rel="manifest" href="/static/manifest.json">
    <!-- <meta name="theme-color" content="#0000ff"> -->
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- favicon -->
    <link rel="icon" type="image/png" href="/static/icons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/static/icons/favicon.svg" />
    <link rel="shortcut icon" href="/static/icons/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png" />


    <!-- Actual Content -->
    <title>3TH Kalender und Buchungssystem</title>

    <meta name="view-type" content="{{ view_type }}">
    <meta name="date" content="{{ date }}">

</head>
<body id="page-body">
    
    {% include 'std_elements/body.html' %}
    <div class="layout-wrapper" id="layoutWrapper" data-layout="mixed">

        {# This sets up the header with the given arguments - these are used in the htmx requests #}
        <form id="viewTypeForm"
                hx-get="{{ url_for('cal_bp.fetch_day')}}"
                hx-target=".calendar-container"
                hx-trigger="load, change from:#dateInput, change from:#viewTypeSelect, change from:#hourSelect"
                hx-request='{"timeout": 800}'
                class="layout-header">

                {% include 'std_elements/header.html' %}
        </form>
        
        <div class="calendar-grid" id="calendar-grid"></div>
        <div class="calendar-container" id="calendar-container"></div>

        {% include 'std_elements/footer.html' %}
        
    </div>


    <script> 
        // checks for timeouts
        document.body.addEventListener('htmx:timeout', function(evt) {
            if (evt.target.closest('#viewTypeForm')) {
                document.querySelector('.calendar-container').innerHTML =
                    "<div class='error-box'>Request timed out. Server might be offline.</div>";
            }
        });
        
        
        // This changes background color based on selected viewtype.
        document.addEventListener('DOMContentLoaded', function () {
            const select = document.getElementById('viewTypeSelect');
            const body = document.getElementById('page-body');
        
            if (select && body) {
                const updateBg = () => {
                    const val = select.value;
                    const color = select.dataset[`bg${val.charAt(0).toUpperCase() + val.slice(1)}`] || 'white';
                    body.style.backgroundColor = color;
                };
        
                select.addEventListener('change', updateBg);
                updateBg();
            }
        });
        // make all selects lose focus on option select
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('viewTypeSelect');
            select?.addEventListener('change', () => select.blur());
        });

        // make viewheight correct.
        function updateViewportHeight() {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
          }
          window.addEventListener('resize', updateViewportHeight);
          window.addEventListener('load', updateViewportHeight);
          

        // escape to close help
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const helpOverlay = document.getElementById('help-overlay');
                if (helpOverlay && !helpOverlay.classList.contains('hidden')) {
                    helpOverlay.classList.add('hidden');
                }
            }
        });
    </script>
        
</body>
</html>
