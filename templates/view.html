<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'std_elements/head.html' %}

    <!-- fontawesome -->
    <script defer src="/static/js/fontawesome/fontawesome.min.js"></script>
    <script defer src="/static/js/fontawesome/solid.min.js"></script>

    <!-- Custom statics -->
    <link rel="stylesheet" href="/static/css/dynamic.css">
    <script src="/static/js/general.js" defer></script>
    <script src="/static/js/dynamic-view.js" defer></script>


    <title>Reservations Week View</title>

    <meta name="view-type" content="{{ view_type }}">
    <meta name="date" content="{{ date }}">

</head>
<body id="page-body">
    
    {% include 'std_elements/body.html' %}
    <div class="layout-wrapper" id="layoutWrapper" data-layout="mixed">

        {# This sets up the header with the given arguments - these are used in the htmx requests #}
        <form id="viewTypeForm"
                hx-get="{{ url_for('cal_bp.fetch_day')}}"
                hx-target=".calendar-container"
                hx-trigger="load, change from:#dateInput, change from:#viewTypeSelect, change from:#hourSelect"
                hx-request='{"timeout": 500}'
                class="layout-header">

                {% include 'std_elements/header.html' %}
        </form>
        
        <div class="calendar-grid" id="calendar-grid"></div>
        <div class="calendar-container" id="calendar-container"></div>

        {% include 'std_elements/footer.html' %}
        
    </div>

    
    <div id="help-overlay" class="hidden" style="
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 70vw;
            background: #fefefe;
            border: 2px solid #aaa;
            border-radius: 8px;
            padding: 1rem 1.5rem;
            z-index: 9999;
            font-family: sans-serif;
            font-size: 0.9rem;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            ">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-direction: column;">
            <strong>⚡ Tastenkürzel</strong>
            <button onclick="document.getElementById('help-overlay').classList.add('hidden')" style="
                border: none;
                background: none;
                font-size: 1.2rem;
                cursor: pointer;
            ">&times;</button>
        </div>
        <hr>
        <div style="line-height: 1.6;">
            <kbd>←</kbd> Vorheriger Tag<br>
            <kbd>→</kbd> Nächster Tag<br>
            <kbd>↑</kbd> Frühere Zeit<br>
            <kbd>↓</kbd> Spätere Zeit<br>
            <kbd>T</kbd> Heute anzeigen<br>
            <kbd>R</kbd> Neu laden<br>
            <kbd>F1</kbd> Hilfe ein-/ausblenden<br>
            <kbd>Esc</kbd> Hilfe schließen
        </div>
    </div>



    <script> 
        // checks for timeouts
        document.body.addEventListener('htmx:timeout', function(evt) {
            if (evt.target.closest('#viewTypeForm')) {
                document.querySelector('.calendar-container').innerHTML =
                    "<div class='error-box'>Request timed out. Server might be offline.</div>";
            }
        });
        
        
        // This changes background color based on selected viewtype.
        document.addEventListener('DOMContentLoaded', function () {
            const select = document.getElementById('viewTypeSelect');
            const body = document.getElementById('page-body');
        
            if (select && body) {
                const updateBg = () => {
                    const val = select.value;
                    const color = select.dataset[`bg${val.charAt(0).toUpperCase() + val.slice(1)}`] || 'white';
                    body.style.backgroundColor = color;
                };
        
                select.addEventListener('change', updateBg);
                updateBg();
            }
        });
        // make all selects lose focus on option select
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('viewTypeSelect');
            select?.addEventListener('change', () => select.blur());
        });

        // make viewheight correct.
        function updateViewportHeight() {
            document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
          }
          window.addEventListener('resize', updateViewportHeight);
          window.addEventListener('load', updateViewportHeight);
          

        // escape to close help
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const helpOverlay = document.getElementById('help-overlay');
                if (helpOverlay && !helpOverlay.classList.contains('hidden')) {
                    helpOverlay.classList.add('hidden');
                }
            }
        });
    </script>
        
</body>
</html>
