<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'std_elements/head.html' %}


    <script src="https://unpkg.com/htmx.org@1.7.0"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker/mdtimepicker.min.css">
    <link rel="stylesheet" href="/static/css/event_form.css">
    <script src="/static/js/event_form.js" defer></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker/mdtimepicker.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the requested table ID from a data attribute on the form or a hidden input
            const requestedTableId = "{{ table_id }}";
    
            if (requestedTableId) {
                // Find the button with the matching data-table-id attribute
                const tableButton = document.querySelector(`.table-button[data-table-id='${requestedTableId}']`);
                if (tableButton) {
                    // Add a class to mark the button as selected
                    tableButton.classList.add('selected');
    
                    // Update the hidden input with the selected table ID
                    document.getElementById('table_ids').value = requestedTableId;
                }
            }
        });
    </script>

    <meta id="eventData" 
        data-name="{{ event.name if event else '' }}" 
        data-description="{{ event.description if event else '' }}"
        data-date="{{ event.date if event else '' }}"
        data-start-time="{{ start_time if event else '' }}"
        data-end-time="{{ end_time if event else '' }}"
        data-game-category-id="{{ event.game_category_id if event else '' }}"
        data-event-type-id="{{ event.event_type_id if event else '' }}"
        data-publicity-id="{{ event.publicity_id if event else '' }}"
        data-selected-tables="{{ event.reservations | map(attribute='table_id') | list | tojson | safe if event else ''}}"
        data-event-id="{{ event.id if event else ''}}"
        data-requested-date="{{ requested_date if requested_date else ''}}">

    
    <title>3TH - Tische buchen</title>
    <style>
        
    </style>
</head>
<body>
    {% include 'std_elements/body.html' %}

    
    
    <h1>{% if event %}Buchung bearbeiten{% else %}Tische buchen{% endif %}</h1>

    <form action="{{ url_for('event_bp.edit_event', event_id=event.id) if event else url_for('event_bp.create_event') }}" method="post" class="main-form">
        <label for="name">Name:</label>
        <input type="text" name="name" id="name" required>

        <label for="description">Beschreibung:</label>
        <textarea name="description" id="description" required></textarea>

        <label for="game_category_id">Kategorie:</label>
        <div style="display: flex; flex-direction: row; align-items: center;">
            <select name="game_category_id" id="game_category_id">
                {% for category in game_categories %}
                    <option value="{{ category.id }}" data-icon="{{ category.icon | safe }}">{{ category.name }}</option>
                {% endfor %}
            </select>
            <div class="icon-preview" id="icon-preview" style="margin-left: 1rem; margin-right: 1rem;"></div>
        </div>

        <label for="event_type_id">Art des Events:</label>
        <select name="event_type_id" id="event_type_id">
            {% for event_type in event_types %}
                <option value="{{ event_type.id }}" data-color="{{ event_type.color }}"">{{ event_type.name }}</option>
            {% endfor %}
        </select>

        <label for="publicity_id">Öffentlichkeit:</label>
        <select name="publicity_id" id="publicity_id">
            {% for publicity in publicity_levels %}
                <option value="{{ publicity.id }}">{{ publicity.name }}</option>
            {% endfor %}
        </select>

        <label for="date">Datum:</label>
        <input type="date" name="date" id="date" required value="{{ event.date if event else '' }}">

        <label for="start_time">Startzeit:</label>
        <input type="time" name="start_time" id="start_time" required value="{{ start_time }}">

        <label for="end_time">Endzeit:</label>
        <input type="time" name="end_time" id="end_time" required value="{{ end_time }}">
        
        <label for="check-availability">Verfügbarkeit prüfen:</label>
        <button id="check-availability" type="button">Prüfen</button>

        <label for="table_ids">Verfügbare Tische:</label>
        <div id="tisch-container" class="tisch-container">
            {% for table in tables %}
                {% if table.type == "Halb" %}
                    <button type="button" class="table-button half-button" data-table-id="{{ table.id }}">
                {% else %}
                    <button type="button" class="table-button" data-table-id="{{ table.id }}">
                {% endif %}
                     {{ table.name }} <!-- <i style="font-size: 0.6rem; color:#bbbcc4;">({{ table.type }})</i> -->
                </button>
            {% endfor %}
        </div>

        <!-- Hidden input to store selected table IDs -->
        <input type="hidden" name="table_ids" id="table_ids" required>

        <input type="hidden" id="is-edit-mode" value="{{ 'true' if event else 'false' }}">


        <button type="submit" id="submitButton" style="display:none"></button>

    </form>

    {% if event %}
        <hr>
        <form action="{{ url_for('event_bp.delete_event', event_id=event.id) }}" 
            method="POST" 
            onsubmit="return confirm('Are you sure you want to delete this event?');"
            style="display: flex; flex-direction: row; justify-content: space-between;">
            <button type="submit" name="action" value="delete" class="delete-button revert-button">Event Löschen</button>
            <button type="submit" name="action" value="cancel" class="cancel-button revert-button">Event absagen</button>
        </form>

    {% endif %}


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // preload the fields if editing

            if (isEditMode) {

                document.getElementById('name').value = eventData.getAttribute('data-name');
                document.getElementById('description').value = eventData.getAttribute('data-description');
                document.getElementById('date').value = eventData.getAttribute('data-date');
                document.getElementById('start_time').value = eventData.getAttribute('data-start-time');
                document.getElementById('end_time').value = eventData.getAttribute('data-end-time');
        
                
                // Set selected game category
                var gameCategoryId = eventData.getAttribute('data-game-category-id');
                if (gameCategoryId) {
                    var gameCategorySelect = document.getElementById('game_category_id');
                    gameCategorySelect.value = gameCategoryId;
                }

                // Set selected event type
                var eventTypeId = eventData.getAttribute('data-event-type-id');
                if (eventTypeId) {
                    var eventTypeSelect = document.getElementById('event_type_id');
                    eventTypeSelect.value = eventTypeId;
                }

                // Set selected publicity level
                var publicityId = eventData.getAttribute('data-publicity-id');
                if (publicityId) {
                    var publicitySelect = document.getElementById('publicity_id');
                    publicitySelect.value = publicityId;
                }

                // Set selected table buttons as "selected"
                const selectedTables = JSON.parse(eventData.getAttribute('data-selected-tables'));
                selectedTables.forEach(tableId => {
                    const tableButton = document.querySelector(`.table-button[data-table-id="${tableId}"]`);
                    if (tableButton) {
                        tableButton.classList.add('selected');
                    }
                });
                
                // Update the hidden input with selected table IDs
                updateSelectedTables();
            }
        });
    </script>
    

</body>
</html>
